{% extends "base.html" %}

{% block title %}HV (Powered by Quantum Blue AI) - Chat{% endblock %}

{% block content %}
<!-- CRITICAL: Block old cached scripts BEFORE anything loads -->
<script>
(function() {
    'use strict';
    const PAGE_VERSION = 'threejs-avatar-v3.0-SERVER-' + Date.now();
    const SERVER_VERSION = '{{ cache_buster if cache_buster else "NO_SERVER_VERSION" }}';
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üöÄ NEW CODE LOADING - Version:', PAGE_VERSION);
    console.log('üì¶ SERVER VERSION:', SERVER_VERSION);
    console.log('üìÖ Timestamp:', new Date().toISOString());
    console.log('üîß Using THREE.js for avatar (NOT Model Viewer)');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    // CRITICAL: If we see old logs, something is wrong
    if (!SERVER_VERSION || SERVER_VERSION === 'NO_SERVER_VERSION') {
        console.error('‚ùå CRITICAL: Server version not found! Flask is serving OLD cached template!');
        console.error('‚ùå Please restart Flask server and clear ALL caches!');
    }
    
    // Force clear any cached THREE.js globals
    if (window.THREE) {
        console.warn('‚ö†Ô∏è Clearing cached THREE.js object');
        delete window.THREE;
    }
    
    // CRITICAL: Check if we have old cached HTML - if so, force reload
    // Check for old scripts in DOM
    const oldScripts = [
        document.querySelector('script[src*="three@0.149"]'),
        document.querySelector('script[src*="three-vrm"]'),
        document.querySelector('script[src*="GLTFLoader.js"]:not([type="module"])'),
        ...Array.from(document.querySelectorAll('script')).filter(s => 
            s.innerHTML && s.innerHTML.includes('Library Loading Check')
        )
    ].filter(Boolean);
    
    // If old scripts are found, just remove them and continue (no reload)
    if (oldScripts.length > 0) {
        console.warn('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.warn('‚ö†Ô∏è OLD CACHED SCRIPTS DETECTED - Removing them...');
        console.warn(`‚ö†Ô∏è Found ${oldScripts.length} old script(s) in page`);
        
        // Remove old scripts immediately and continue
        oldScripts.forEach(s => {
            console.warn('üö´ Removing old cached script:', s.src || 'inline script');
            s.remove();
        });
        
        console.warn('‚úÖ Old scripts removed - continuing with new code');
        console.warn('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    }
    
    // Remove any old script tags immediately (but don't log excessively)
    const oldScriptTags = document.querySelectorAll('script[src*="three@0.149"], script[src*="three-vrm"], script[src*="GLTFLoader.js"]:not([type="module"])');
    if (oldScriptTags.length > 0) {
        console.warn(`üö´ Found and removing ${oldScriptTags.length} old cached script(s)`);
        oldScriptTags.forEach(s => s.remove());
    }
    console.log('üîÑ Page version:', PAGE_VERSION, '- Clearing cached scripts');
    
    // If old THREE.js is already loaded, warn and clear
    if (typeof THREE !== 'undefined') {
        console.warn('‚ö†Ô∏è OLD THREE.js detected in cache - this should NOT be here!');
        console.warn('‚ö†Ô∏è Please clear browser cache (Ctrl+Shift+Delete)');
        // Try to clean up
        delete window.THREE;
        delete window.THREE_VRM;
    }
    
    // Block script tags with Three.js, GLTFLoader, VRM, Babylon
    const blockedPatterns = ['three.js', 'GLTFLoader', 'three-vrm', 'babylon'];
    
    // Remove any existing blocked scripts from DOM immediately
    function removeBlockedScripts() {
        const scripts = document.querySelectorAll('script[src]');
        scripts.forEach(function(script) {
            blockedPatterns.forEach(function(pattern) {
                if (script.src && script.src.includes(pattern)) {
                    console.warn('üö´ Removing cached script from DOM:', script.src);
                    script.remove();
                }
            });
        });
    }
    
    // Run immediately
    removeBlockedScripts();
    
    // Run again after a short delay to catch late-loading scripts
    setTimeout(removeBlockedScripts, 100);
    setTimeout(removeBlockedScripts, 500);
    
    // Intercept script tag creation
    const Observer = window.MutationObserver || window.WebKitMutationObserver;
    if (Observer) {
        const observer = new Observer(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.tagName === 'SCRIPT' && node.src) {
                        blockedPatterns.forEach(function(pattern) {
                            if (node.src.includes(pattern)) {
                                console.warn('üö´ Blocked cached script:', node.src);
                                node.remove();
                                return false;
                            }
                        });
                    }
                });
            });
        });
        observer.observe(document.head, { childList: true, subtree: true });
        observer.observe(document.body, { childList: true, subtree: true });
    }
    
    // Also override createElement early
    const originalCreateElement = document.createElement.bind(document);
    document.createElement = function(tagName, options) {
        const element = originalCreateElement(tagName, options);
        if (tagName.toLowerCase() === 'script') {
            const originalSetAttribute = element.setAttribute.bind(element);
            element.setAttribute = function(name, value) {
                if (name === 'src' && value) {
                    for (let i = 0; i < blockedPatterns.length; i++) {
                        if (value.includes(blockedPatterns[i])) {
                            console.warn('üö´ Prevented script:', value);
                            return; // Block it
                        }
                    }
                }
                return originalSetAttribute(name, value);
            };
        }
        return element;
    };
    
    console.log('‚úÖ Early script blocker active');
})();
</script>
<div class="chat-container">
    <!-- Left Side: 3D VRM Avatar -->
    <div class="avatar-section" style="position: relative; z-index: 1; pointer-events: auto;">
        <div id="avatar-container" style="width: 100%; height: 100%; position: relative; min-height: 500px; pointer-events: auto;">
            <!-- THREE.js Canvas Container -->
            <div id="three-canvas-container" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; pointer-events: auto;">
                <!-- THREE.js will render here -->
            </div>
            <!-- Fallback 2D Avatar (shown if THREE.js fails) -->
            <div class="simple-avatar" id="simple-avatar-fallback" style="display: none; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;">
                <div style="text-align: center; position: relative;">
                    <div class="avatar-antenna"></div>
                    <div class="avatar-head">
                        <div class="avatar-eyes">
                            <div class="avatar-eye"></div>
                            <div class="avatar-eye"></div>
                        </div>
                        <div class="avatar-mouth"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Side: Chatbot Interface -->
    <div class="chat-section">
        <div class="card shadow-lg h-100" style="position: relative;">
            <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center" style="position: relative;">
                <div class="d-flex align-items-center">
                    <img src="/static/Images/Q_logo_quantum_blue-removebg-preview.png" alt="Quantum Blue Logo" style="width: 180px; height: 80px; margin-right: -50px; margin-left: -50px; margin-top: -8px; object-fit: contain;">
                    <h6 class="mb-0 me-3" style="font-size: 1.1rem;">
                        HV (Powered by Quantum Blue AI)
                    </h6>
                </div>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-light d-flex align-items-center gap-1" onclick="toggleUserInfoPanel()" data-i18n-title="buttons.userInfo" title="Toggle User Info" id="userInfoToggleBtn">
                        <i class="fas fa-chevron-down" id="userInfoToggleIcon"></i>
                        <span data-i18n="buttons.userInfo">User Info</span>
                    </button>
                    <a href="https://highvolt.tech/demo-ss-dashboard/" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-light d-flex align-items-center gap-1" data-i18n-title="buttons.dashboard" title="Open Dashboard">
                        <i class="fas fa-chart-line"></i>
                        <span data-i18n="buttons.dashboard">Dashboard</span>
                    </a>
                    <select id="languageSelector" class="btn btn-sm btn-light" style="border: 1px solid #dee2e6; padding: 6px 12px; cursor: pointer;" onchange="changeLanguage(this.value)">
                        <option value="en">üá∫üá∏ English</option>
                        <option value="my">üá≤üá≤ ·Äô·Äº·Äî·Ä∫·Äô·Ä¨ (Burmese)</option>
                        <option value="hi">üáÆüá≥ ‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                        <option value="te">üáÆüá≥ ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
                    </select>
                    <button class="btn btn-sm btn-light d-flex align-items-center gap-1" onclick="resetChat()" data-i18n-title="buttons.reset" title="Reset Chat - Start New Conversation">
                        <i class="fas fa-redo"></i>
                        <span data-i18n="buttons.reset">Reset</span>
                    </button>
                    <button class="btn btn-sm btn-light d-flex align-items-center gap-1" onclick="viewCart()" data-i18n-title="buttons.cart" title="View Cart" id="cartButton" style="display: none;">
                        <i class="fas fa-shopping-cart"></i>
                        <span data-i18n="buttons.cart">Cart</span>
                    </button>
                </div>
            </div>
            <div class="card-body p-0 d-flex flex-column">
                
                <!-- User Info Panel (hidden by default) -->
                <div id="userInfoPanel" class="bg-gradient-light p-2 border-bottom shadow-sm" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="user-info-item">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <i class="fas fa-user text-primary"></i>
                                <span class="text-muted small" data-i18n="labels.user">User</span>
                            </div>
                            <div class="fw-bold text-primary" id="userName">-</div>
                        </div>
                        <div class="user-info-item">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <i class="fas fa-map-marker-alt text-primary"></i>
                                <span class="text-muted small" data-i18n="labels.area">Area</span>
                            </div>
                            <div class="fw-bold text-primary" id="userArea">-</div>
                        </div>
                        <div class="user-info-item">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <i class="fas fa-tag text-primary"></i>
                                <span class="text-muted small" data-i18n="labels.type">Type</span>
                            </div>
                            <div class="fw-bold text-primary" id="userType">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Messages -->
                <div id="chatMessages" class="chat-messages p-3 flex-grow-1" style="overflow-y: auto; min-height: 0;">
                    <div class="text-center text-muted py-5">
                        <img src="/static/Images/Q_logo_quantum_blue-removebg-preview.png" alt="Quantum Blue Logo" style="width: 180px; height: 100px; margin-bottom: 24px; object-fit: contain;">
                        <h4>Welcome to HV (Powered by Quantum Blue AI)</h4>
                        <p>Your intelligent assistant for orders, tracking, and more!</p>
                    </div>
                </div>
                
                <!-- Action Buttons - REMOVED per user request -->
                
                <!-- Input Area -->
                <div class="p-3 border-top">
                    <div class="position-relative">
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" 
                                   data-i18n-placeholder="placeholders.typeMessage"
                                   placeholder="Type your message..." autocomplete="off" />
                            <button class="btn btn-primary" onclick="sendMessage()" id="sendButton" disabled>
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </div>
                        <!-- Product Recommendations Dropdown -->
                        <div id="productRecommendations" class="position-absolute w-100 bg-white border rounded shadow-lg" 
                             style="top: 100%; z-index: 1000; max-height: 300px; overflow-y: auto; display: none; margin-top: 2px;">
                            <div id="recommendationsList"></div>
                        </div>
                    </div>
                    <div class="form-text small text-muted mt-1">
                        Press Enter to send ‚Ä¢ Shift+Enter for new line
                    </div>
                    <div id="typingIndicator" class="text-muted small mt-2" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span>Quantum Blue is thinking...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cart Modal -->
<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shopping-cart"></i> Your Cart
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="cartContent">
                    <!-- Cart items will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info" onclick="saveCartAsTemplate()">
                    <i class="fas fa-save"></i> Save as Template
                </button>
                <button type="button" class="btn btn-success" onclick="placeOrder()">Confirm Cart & Place Order</button>
            </div>
        </div>
    </div>
</div>

<!-- Order Summary Modal -->
<div class="modal fade" id="orderSummaryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-receipt"></i> Order Summary
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="orderSummaryContent">
                    <!-- Order summary will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="confirmPlaceOrder()">Confirm Order</button>
            </div>
        </div>
    </div>
</div>

<!-- Script blocker is already installed above -->

<!-- THREE.js Avatar Loader (Module) -->
<script type="module">
// Add aggressive cache-busting with server timestamp
const THREE_AVATAR_VERSION = '{{ cache_buster if cache_buster else range(1000, 9999) | random }}';
const THREE_AVATAR_URL = "{{ url_for('static', filename='js/three_avatar.js') }}?v=" + THREE_AVATAR_VERSION + "&t=" + Date.now() + "&cb=" + Math.random();

console.log('[THREE-MODULE-LOADER] Loading THREE.js avatar module...');
console.log('[THREE-MODULE-LOADER] URL:', THREE_AVATAR_URL);

// Create and load the module
const script = document.createElement('script');
script.type = 'module';
script.src = THREE_AVATAR_URL;

script.onload = () => {
    console.log('[THREE-MODULE-LOADER] ‚úÖ THREE.js avatar module script tag loaded');
};

script.onerror = (error) => {
    console.error('[THREE-MODULE-LOADER] ‚ùå Failed to load THREE.js avatar module:', error);
    console.error('[THREE-MODULE-LOADER] Error details:', {
        type: error.type,
        target: error.target,
        message: error.message
    });
    
    // Show fallback immediately
    const fallback = document.getElementById('simple-avatar-fallback');
    const status = document.getElementById('status-text');
    if (fallback) {
        fallback.style.display = 'flex';
    }
    if (status) {
        status.textContent = 'Using fallback avatar (Module load failed)';
    }
};

document.head.appendChild(script);
</script>

<!-- 
    OLD MODEL-VIEWER CODE REMOVED - Now using THREE.js for avatar loading
    See: static/js/three_avatar.js
    
    All old code has been completely removed.
-->

<!-- Avatar Functions (for chat integration) - Using three_avatar.js instead of avatar.js -->
<!-- i18n initialization must load before enhanced_chat.js -->
<script src="{{ url_for('static', filename='js/i18n.js') }}?v={{ cache_buster if cache_buster else range(1000, 9999) | random }}&t={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/enhanced_chat.js') }}?v={{ cache_buster if cache_buster else range(1000, 9999) | random }}&t={{ range(1000, 9999) | random }}"></script>

<!-- User Info Panel Toggle Function -->
<script>
function toggleUserInfoPanel() {
    const panel = document.getElementById('userInfoPanel');
    const icon = document.getElementById('userInfoToggleIcon');
    const btn = document.getElementById('userInfoToggleBtn');
    
    if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'block';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
        if (btn) {
            btn.classList.add('active');
        }
    } else {
        panel.style.display = 'none';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
        if (btn) {
            btn.classList.remove('active');
        }
    }
}
</script>

<!-- Fallback: If THREE.js module fails to load, show fallback avatar -->
<script>
(function() {
    console.log('[FALLBACK-CHECK] Checking if THREE.js avatar loaded...');
    
    // Wait for THREE.js to initialize
    setTimeout(() => {
        // Check if avatar loaded event was fired
        if (!window.avatarLoaded && typeof window.avatarSpeak !== 'function') {
            console.warn('[FALLBACK-CHECK] THREE.js avatar not loaded, showing fallback');
            const fallback = document.getElementById('simple-avatar-fallback');
            const status = document.getElementById('status-text');
            if (fallback) {
                fallback.style.display = 'flex';
            }
            if (status) {
                status.textContent = 'Using fallback avatar';
            }
        }
    }, 5000);
    
    // Listen for avatar loaded event
    window.addEventListener('avatarLoaded', () => {
        console.log('[FALLBACK-CHECK] ‚úÖ Avatar loaded successfully');
        window.avatarLoaded = true;
    });
})();
</script>
{% endblock %}
